<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>নুরুল কুরআন কওমি মাদরাসা</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'SolaimanLipi', Arial, sans-serif !important;
            background-color: #f5f5f5;
        }
        .header {
            background-color: #2c7be5;
            color: white;
            padding: 15px 0;
            margin-bottom: 20px;
            border-radius: 0 0 10px 10px;
        }
        .btn-primary {
            background-color: #2c7be5;
            border-color: #2c7be5;
        }
        .btn-secondary {
            background-color: #6c757d;
            border-color: #6c757d;
        }
        .btn-success {
            background-color: #00a854;
            border-color: #00a854;
        }
        .btn-danger {
            background-color: #f46a6a;
            border-color: #f46a6a;
        }
        .btn-warning {
            background-color: #f7b924;
            border-color: #f7b924;
        }
        .list-group-item {
            margin-bottom: 10px;
            border-radius: 5px;
        }
        .form-container {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .hidden {
            display: none;
        }
        .page-title {
            color: #2c7be5;
            margin-bottom: 20px;
            border-bottom: 2px solid #2c7be5;
            padding-bottom: 10px;
        }
        .back-btn {
            margin-bottom: 15px;
        }
        .search-box {
            margin-bottom: 15px;
        }
        .student-card {
            cursor: pointer;
            transition: all 0.3s;
        }
        .student-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .unpaid-badge {
            font-size: 14px;
        }
        @font-face {
            font-family: 'SolaimanLipi';
            src: url('https://cdn.rawgit.com/muttaqin/solaimanlipi/7c1c8213/SolaimanLipi.ttf') format('truetype');
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Header -->
        <div class="header text-center">
            <h1>নুরুল কুরআন কওমি মাদরাসা</h1>
        </div>

        <!-- Home Page -->
        <div id="home-page">
            <div class="row">
                <div class="col-md-6 offset-md-3">
                    <div class="d-grid gap-2">
                        <button class="btn btn-primary btn-lg mb-2" onclick="showClassList('shishu')">শিশু জামাত</button>
                        <button class="btn btn-primary btn-lg mb-2" onclick="showClassList('first')">প্রথম জামাত</button>
                        <button class="btn btn-primary btn-lg mb-2" onclick="showClassList('second')">দ্বিতীয় জামাত</button>
                        <button class="btn btn-primary btn-lg mb-2" onclick="showClassList('third')">তৃতীয় জামাত</button>
                        <button class="btn btn-primary btn-lg mb-2" onclick="showClassList('hifz')">হিফজ বিভাগ</button>
                        <button class="btn btn-success btn-lg mb-2" onclick="showAddStudentForm()">Add Student</button>
                        <button class="btn btn-warning btn-lg mb-2" onclick="showFeeForm()">বেতন দিন</button>
                        <button class="btn btn-danger btn-lg mb-2" onclick="showUnpaidStudents()">Unpaid Student</button>
                        <button class="btn btn-info btn-lg mb-2" onclick="showTodayPaidStudents()">আজকে যারা বেতন দিয়েছেন</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Student Form -->
        <div id="add-student-page" class="hidden">
            <div class="row">
                <div class="col-md-6 offset-md-3">
                    <button class="btn btn-secondary back-btn" onclick="backToHome()">← Back</button>
                    <h2 class="page-title">নতুন ছাত্র যোগ করুন</h2>
                    <div class="form-container">
                        <form id="add-student-form">
                            <div class="mb-3">
                                <label for="student-class" class="form-label">ক্লাস নির্ণয় করুন</label>
                                <select class="form-select" id="student-class" required>
                                    <option value="" selected disabled>ক্লাস নির্বাচন করুন</option>
                                    <option value="shishu">শিশু জামাত</option>
                                    <option value="first">প্রথম জামাত</option>
                                    <option value="second">দ্বিতীয় জামাত</option>
                                    <option value="third">তৃতীয় জামাত</option>
                                    <option value="hifz">হিফজ বিভাগ</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="student-name" class="form-label">নাম</label>
                                <input type="text" class="form-control" id="student-name" required>
                            </div>
                            <div class="mb-3">
                                <label for="father-name" class="form-label">পিতার নাম</label>
                                <input type="text" class="form-control" id="father-name" required>
                            </div>
                            <div class="mb-3">
                                <label for="mother-name" class="form-label">মাতার নাম (Optional)</label>
                                <input type="text" class="form-control" id="mother-name">
                            </div>
                            <div class="mb-3">
                                <label for="mobile-number" class="form-label">মোবাইল নাম্বার</label>
                                <input type="tel" class="form-control" id="mobile-number" required>
                            </div>
                            <button type="submit" class="btn btn-primary">সাবমিট</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Class List Page -->
        <div id="class-list-page" class="hidden">
            <div class="row">
                <div class="col-md-8 offset-md-2">
                    <button class="btn btn-secondary back-btn" onclick="backToHome()">← Back</button>
                    <h2 id="class-list-title" class="page-title"></h2>
                    <div class="search-box">
                        <input type="text" class="form-control" id="student-search" placeholder="ছাত্র খুঁজুন...">
                    </div>
                    <div id="class-list-container"></div>
                </div>
            </div>
        </div>

        <!-- Fee Management Page -->
        <div id="fee-page" class="hidden">
            <div class="row">
                <div class="col-md-6 offset-md-3">
                    <button class="btn btn-secondary back-btn" onclick="backToHome()">← Back</button>
                    <h2 class="page-title">বেতন প্রদান</h2>
                    <div class="form-container">
                        <form id="fee-form">
                            <div class="mb-3">
                                <label for="fee-class" class="form-label">ক্লাস নির্বাচন করুন</label>
                                <select class="form-select" id="fee-class" required>
                                    <option value="" selected disabled>ক্লাস নির্বাচন করুন</option>
                                    <option value="shishu">শিশু জামাত</option>
                                    <option value="first">প্রথম জামাত</option>
                                    <option value="second">দ্বিতীয় জামাত</option>
                                    <option value="third">তৃতীয় জামাত</option>
                                    <option value="hifz">হিফজ বিভাগ</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="student-select" class="form-label">ছাত্র নির্বাচন করুন</label>
                                <input type="text" class="form-control" id="student-select" placeholder="ছাত্রের নাম লিখুন" required>
                                <div id="student-suggestions" class="list-group mt-2 hidden"></div>
                            </div>
                            <div class="mb-3">
                                <label for="total-fee" class="form-label">মোট বেতন</label>
                                <input type="number" class="form-control" id="total-fee" required>
                            </div>
                            <div class="mb-3">
                                <label for="paid-amount" class="form-label">বর্তমান টাকা</label>
                                <input type="number" class="form-control" id="paid-amount" required>
                            </div>
                            <div class="mb-3">
                                <label for="due-amount" class="form-label">বকেয়া টাকা</label>
                                <input type="number" class="form-control" id="due-amount" readonly>
                            </div>
                            <button type="submit" class="btn btn-primary">সাবমিট</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Unpaid Students Page -->
        <div id="unpaid-page" class="hidden">
            <div class="row">
                <div class="col-md-10 offset-md-1">
                    <button class="btn btn-secondary back-btn" onclick="backToHome()">← Back</button>
                    <h2 class="page-title">বেতন বকেয়া ছাত্ররা</h2>
                    <div class="d-flex mb-3">
                        <button class="btn btn-primary me-2" onclick="showUnpaidClass('shishu')">শিশু জামাত</button>
                        <button class="btn btn-primary me-2" onclick="showUnpaidClass('first')">প্রথম জামাত</button>
                        <button class="btn btn-primary me-2" onclick="showUnpaidClass('second')">দ্বিতীয় জামাত</button>
                        <button class="btn btn-primary me-2" onclick="showUnpaidClass('third')">তৃতীয় জামাত</button>
                        <button class="btn btn-primary" onclick="showUnpaidClass('hifz')">হিফজ বিভাগ</button>
                    </div>
                    <div id="unpaid-list-container"></div>
                </div>
            </div>
        </div>
        <!-- Today's Paid Students Page -->
        <div id="today-paid-page" class="hidden">
            <div class="row">
                <div class="col-md-10 offset-md-1">
                    <button class="btn btn-secondary back-btn" onclick="backToHome()">← Back</button>
                    <h2 class="page-title">আজকে যারা বেতন দিয়েছেন</h2>
                    <div class="d-flex mb-3">
                        <button class="btn btn-primary me-2" onclick="showTodayPaidClass('shishu')">শিশু জামাত</button>
                        <button class="btn btn-primary me-2" onclick="showTodayPaidClass('first')">প্রথম জামাত</button>
                        <button class="btn btn-primary me-2" onclick="showTodayPaidClass('second')">দ্বিতীয় জামাত</button>
                        <button class="btn btn-primary me-2" onclick="showTodayPaidClass('third')">তৃতীয় জামাত</button>
                        <button class="btn btn-primary" onclick="showTodayPaidClass('hifz')">হিফজ বিভাগ</button>
                    </div>
                    <div id="today-paid-container"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Student Modal -->
    <div class="modal fade" id="editStudentModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ছাত্র তথ্য সম্পাদনা</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="edit-student-form">
                        <input type="hidden" id="edit-student-id">
                        <div class="mb-3">
                            <label for="edit-student-name" class="form-label">নাম</label>
                            <input type="text" class="form-control" id="edit-student-name" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit-father-name" class="form-label">পিতার নাম</label>
                            <input type="text" class="form-control" id="edit-father-name" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit-mother-name" class="form-label">মাতার নাম</label>
                            <input type="text" class="form-control" id="edit-mother-name">
                        </div>
                        <div class="mb-3">
                            <label for="edit-mobile-number" class="form-label">মোবাইল নাম্বার</label>
                            <input type="tel" class="form-control" id="edit-mobile-number" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">বাতিল</button>
                    <button type="button" class="btn btn-primary" onclick="updateStudent()">আপডেট</button>
                    <button type="button" class="btn btn-danger" onclick="deleteStudent()">ডিলিট</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Google Sheet API URL - Replace with your actual Google Apps Script URL
        const API_URL = "https://script.google.com/macros/s/AKfycbwElAavjak1Qv8l8_CcnI4LTFL_6NCLHUcMqT_ZjZ861bB9BBWG6IBJ3024ZCcuuUbW/exec";
        
        // Current page state
        let currentPage = 'home';
        let currentClass = '';
        let studentsData = [];
        let offlineData = JSON.parse(localStorage.getItem('offlineData')) || { students: [], fees: [] };
        
        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            // Check if online and sync offline data
            if (navigator.onLine) {
                syncOfflineData();
            }
            
            // Form submissions
            document.getElementById('add-student-form').addEventListener('submit', addStudent);
            document.getElementById('fee-form').addEventListener('submit', submitFee);
            document.getElementById('student-search').addEventListener('input', searchStudents);
            document.getElementById('student-select').addEventListener('input', searchStudentsForFee);
            
            // Calculate due amount automatically
            document.getElementById('paid-amount').addEventListener('input', calculateDueAmount);
            document.getElementById('total-fee').addEventListener('input', calculateDueAmount);
        });
        
        // Navigation functions
        function backToHome() {
            document.getElementById(currentPage + '-page').classList.add('hidden');
            document.getElementById('home-page').classList.remove('hidden');
            currentPage = 'home';
        }
        
        function showAddStudentForm() {
            document.getElementById('home-page').classList.add('hidden');
            document.getElementById('add-student-page').classList.remove('hidden');
            currentPage = 'add-student';
            document.getElementById('add-student-form').reset();
        }
        
        function showClassList(className) {
            document.getElementById('home-page').classList.add('hidden');
            document.getElementById('class-list-page').classList.remove('hidden');
            currentPage = 'class-list';
            currentClass = className;
            
            // Set title based on class
            const classTitles = {
                'shishu': 'শিশু জামাত',
                'first': 'প্রথম জামাত',
                'second': 'দ্বিতীয় জামাত',
                'third': 'তৃতীয় জামাত',
                'hifz': 'হিফজ বিভাগ'
            };
            document.getElementById('class-list-title').textContent = classTitles[className];
            
            // Load students for this class
            loadStudents(className);
        }
        
        function showFeeForm() {
            document.getElementById('home-page').classList.add('hidden');
            document.getElementById('fee-page').classList.remove('hidden');
            currentPage = 'fee';
            document.getElementById('fee-form').reset();
        }
        
        function showUnpaidStudents() {
            document.getElementById('home-page').classList.add('hidden');
            document.getElementById('unpaid-page').classList.remove('hidden');
            currentPage = 'unpaid';
            showUnpaidClass('shishu'); // Default to shishu class
        }
        
        function showTodayPaidStudents() {
            document.getElementById('home-page').classList.add('hidden');
            document.getElementById('today-paid-page').classList.remove('hidden');
            currentPage = 'today-paid';
            showTodayPaidClass('shishu'); // Default to shishu class
        }
        
        function showUnpaidClass(className) {
            currentClass = className;
            fetchUnpaidStudents(className);
        }
        
        function showTodayPaidClass(className) {
            currentClass = className;
            fetchTodayPaidStudents(className);
        }
        
        // Data functions
        function addStudent(e) {
            e.preventDefault();
            
            const studentClass = document.getElementById('student-class').value;
            const name = document.getElementById('student-name').value;
            const fatherName = document.getElementById('father-name').value;
            const motherName = document.getElementById('mother-name').value;
            const mobile = document.getElementById('mobile-number').value;
            
            const studentData = {
                class: studentClass,
                name: name,
                fatherName: fatherName,
                motherName: motherName,
                mobile: mobile,
                timestamp: new Date().toISOString()
            };
            
            if (navigator.onLine) {
                // Online - send to Google Sheet
                fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'addStudent',
                        data: studentData
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('ছাত্র সফলভাবে যোগ করা হয়েছে!');
                        document.getElementById('add-student-form').reset();
                    } else {
                        alert('ত্রুটি: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    // Save to offline storage if online submission fails
                    saveStudentOffline(studentData);
                    alert('অনলাইন সংযোগ ব্যর্থ। ডাটা অফলাইনে সংরক্ষিত হয়েছে।');
                });
            } else {
                // Offline - save to localStorage
                saveStudentOffline(studentData);
                alert('আপনি অফলাইনে আছেন। ডাটা অফলাইনে সংরক্ষিত হয়েছে।');
            }
        }
        
        function saveStudentOffline(studentData) {
            offlineData.students.push(studentData);
            localStorage.setItem('offlineData', JSON.stringify(offlineData));
        }
        
        function syncOfflineData() {
            if (offlineData.students.length > 0) {
                // Sync students
                fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'syncStudents',
                        data: offlineData.students
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Clear synced students
                        offlineData.students = [];
                        localStorage.setItem('offlineData', JSON.stringify(offlineData));
                    }
                });
            }
            
            if (offlineData.fees.length > 0) {
                // Sync fees
                fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'syncFees',
                        data: offlineData.fees
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Clear synced fees
                        offlineData.fees = [];
                        localStorage.setItem('offlineData', JSON.stringify(offlineData));
                    }
                });
            }
        }
        function loadStudents(className) {
            if (navigator.onLine) {
                fetch(API_URL + '?action=getStudents&class=' + className)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            studentsData = data.data;
                            displayStudents(studentsData);
                        } else {
                            alert('ত্রুটি: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('ডাটা লোড করতে ব্যর্থ হয়েছে।');
                    });
            } else {
                alert('আপনি অফলাইনে আছেন। শুধুমাত্র পূর্বে দেখা ডাটা দেখানো যাবে।');
                // In a real app, you might cache data for offline viewing
            }
        }
        
        function displayStudents(students) {
            const container = document.getElementById('class-list-container');
            container.innerHTML = '';
            
            if (students.length === 0) {
                container.innerHTML = '<div class="alert alert-info">কোন ছাত্র পাওয়া যায়নি</div>';
                return;
            }
            
            students.forEach((student, index) => {
                const card = document.createElement('div');
                card.className = 'card mb-3 student-card';
                card.innerHTML = `
                    <div class="card-body">
                        <h5 class="card-title">${student.name}</h5>
                        <p class="card-text">পিতার নাম: ${student.fatherName}</p>
                        <p class="card-text">মোবাইল: <a href="tel:${student.mobile}">${student.mobile}</a></p>
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <span class="badge bg-success">${student.paidMonths || 0} মাস বেতন</span>
                                <span class="badge bg-danger unpaid-badge">${student.dueAmount || 0} টাকা বকেয়া</span>
                            </div>
                            <div>
                                <button class="btn btn-sm btn-warning me-2" onclick="editStudent('${currentClass}', ${index})">Edit</button>
                                <button class="btn btn-sm btn-primary" onclick="payFeeForStudent('${currentClass}', '${student.name}', '${student.fatherName}', '${student.mobile}')">Fee</button>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }
        
        function searchStudents() {
            const searchTerm = document.getElementById('student-search').value.toLowerCase();
            if (!searchTerm) {
                displayStudents(studentsData);
                return;
            }
            
            const filtered = studentsData.filter(student => 
                student.name.toLowerCase().includes(searchTerm) || 
                student.fatherName.toLowerCase().includes(searchTerm) ||
                student.mobile.includes(searchTerm)
            );
            
            displayStudents(filtered);
        }
        
        function editStudent(className, index) {
            const student = studentsData[index];
            document.getElementById('edit-student-id').value = student.id || index;
            document.getElementById('edit-student-name').value = student.name;
            document.getElementById('edit-father-name').value = student.fatherName;
            document.getElementById('edit-mother-name').value = student.motherName || '';
            document.getElementById('edit-mobile-number').value = student.mobile;
            
            const modal = new bootstrap.Modal(document.getElementById('editStudentModal'));
            modal.show();
        }
        
        function updateStudent() {
            const id = document.getElementById('edit-student-id').value;
            const name = document.getElementById('edit-student-name').value;
            const fatherName = document.getElementById('edit-father-name').value;
            const motherName = document.getElementById('edit-mother-name').value;
            const mobile = document.getElementById('edit-mobile-number').value;
            
            const updatedData = {
                id: id,
                class: currentClass,
                name: name,
                fatherName: fatherName,
                motherName: motherName,
                mobile: mobile
            };
            
            if (navigator.onLine) {
                fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'updateStudent',
                        data: updatedData
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('ছাত্রের তথ্য সফলভাবে আপডেট করা হয়েছে!');
                        loadStudents(currentClass);
                        const modal = bootstrap.Modal.getInstance(document.getElementById('editStudentModal'));
                        modal.hide();
                    } else {
                        alert('ত্রুটি: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('আপডেট করতে ব্যর্থ হয়েছে।');
                });
            } else {
                alert('আপনি অফলাইনে আছেন। আপডেট করার জন্য অনলাইনে যান।');
            }
        }
        
        function deleteStudent() {
            if (!confirm('আপনি কি নিশ্চিত এই ছাত্রকে ডিলিট করতে চান?')) return;
            
            const id = document.getElementById('edit-student-id').value;
            
            if (navigator.onLine) {
                fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'deleteStudent',
                        class: currentClass,
                        id: id
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('ছাত্র সফলভাবে ডিলিট করা হয়েছে!');
                        loadStudents(currentClass);
                        const modal = bootstrap.Modal.getInstance(document.getElementById('editStudentModal'));
                        modal.hide();
                    } else {
                        alert('ত্রুটি: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('ডিলিট করতে ব্যর্থ হয়েছে।');
                });
            } else {
                alert('আপনি অফলাইনে আছেন। ডিলিট করার জন্য অনলাইনে যান।');
            }
        }
        
        function payFeeForStudent(className, studentName, fatherName, mobile) {
            showFeeForm();
            document.getElementById('fee-class').value = className;
            document.getElementById('student-select').value = studentName;
            // In a real app, you would auto-fill other fields based on student data
        }
        
        // Fee management functions
        function searchStudentsForFee() {
            const searchTerm = document.getElementById('student-select').value.toLowerCase();
            const classSelect = document.getElementById('fee-class').value;
            
            if (!searchTerm || !classSelect) {
                document.getElementById('student-suggestions').classList.add('hidden');
                return;
            }
            
            // In a real app, you would fetch students matching the search term from the selected class
            // For demo, we'll just show some dummy suggestions
            const suggestions = [
                { name: 'আব্দুল্লাহ আল মামুন', fatherName: 'মোঃ আব্দুল হাকিম', mobile: '01712345678' },
                { name: 'মোহাম্মদ আলী', fatherName: 'মোঃ আব্দুল করিম', mobile: '01787654321' }
            ].filter(s => 
                s.name.toLowerCase().includes(searchTerm) || 
                s.fatherName.toLowerCase().includes(searchTerm)
            );
            
            const suggestionsContainer = document.getElementById('student-suggestions');
            suggestionsContainer.innerHTML = '';
            
            if (suggestions.length === 0) {
                suggestionsContainer.classList.add('hidden');
                return;
            }
            
            suggestions.forEach(student => {
                const item = document.createElement('button');
                item.type = 'button';
                item.className = 'list-group-item list-group-item-action';
                item.innerHTML = `
                    <div>${student.name}</div>
                    <small class="text-muted">পিতা: ${student.fatherName}, মোবাইল: ${student.mobile}</small>
                `;
                item.onclick = function() {
                    document.getElementById('student-select').value = student.name;
                    suggestionsContainer.classList.add('hidden');
                    // In a real app, you would auto-fill other student details
                };
                suggestionsContainer.appendChild(item);
            });
            
            suggestionsContainer.classList.remove('hidden');
        }
        
        function calculateDueAmount() {
            const totalFee = parseFloat(document.getElementById('total-fee').value) || 0;
            const paidAmount = parseFloat(document.getElementById('paid-amount').value) || 0;
            const dueAmount = totalFee - paidAmount;
            document.getElementById('due-amount').value = dueAmount.toFixed(2);
        }
        
        function submitFee(e) {
            e.preventDefault();
            
            const className = document.getElementById('fee-class').value;
            const studentName = document.getElementById('student-select').value;
            const totalFee = document.getElementById('total-fee').value;
            const paidAmount = document.getElementById('paid-amount').value;
            const dueAmount = document.getElementById('due-amount').value;
            
            const feeData = {
                class: className,
                studentName: studentName,
                totalFee: totalFee,
                paidAmount: paidAmount,
                dueAmount: dueAmount,
                paymentDate: new Date().toISOString()
            };
            
            if (navigator.onLine) {
                fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'submitFee',
                        data: feeData
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('বেতন সফলভাবে জমা দেওয়া হয়েছে!');
                        document.getElementById('fee-form').reset();
                    } else {
                        alert('ত্রুটি: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    // Save to offline storage if online submission fails
                    saveFeeOffline(feeData);
                    alert('অনলাইন সংযোগ ব্যর্থ। ডাটা অফলাইনে সংরক্ষিত হয়েছে।');
                });
            } else {
                // Offline - save to localStorage
                saveFeeOffline(feeData);
                alert('আপনি অফলাইনে আছেন। ডাটা অফলাইনে সংরক্ষিত হয়েছে।');
            }
        }
        
        function saveFeeOffline(feeData) {
            offlineData.fees.push(feeData);
            localStorage.setItem('offlineData', JSON.stringify(offlineData));
        }
        
        function fetchUnpaidStudents(className) {
            if (navigator.onLine) {
                fetch(API_URL + '?action=getUnpaidStudents&class=' + className)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            displayUnpaidStudents(data.data);
                        } else {
                            alert('ত্রুটি: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('ডাটা লোড করতে ব্যর্থ হয়েছে।');
                    });
            } else {
                alert('আপনি অফলাইনে আছেন। শুধুমাত্র পূর্বে দেখা ডাটা দেখানো যাবে।');
            }
        }
        
        function displayUnpaidStudents(students) {
            const container = document.getElementById('unpaid-list-container');
            container.innerHTML = '';
            
            if (students.length === 0) {
                container.innerHTML = '<div class="alert alert-info">কোন বকেয়া ছাত্র পাওয়া যায়নি</div>';
                return;
            }
            students.forEach(student => {
                const card = document.createElement('div');
                card.className = 'card mb-3';
                card.innerHTML = `
                    <div class="card-body">
                        <h5 class="card-title">${student.name}</h5>
                        <p class="card-text">পিতার নাম: ${student.fatherName}</p>
                        <p class="card-text">মোবাইল: <a href="tel:${student.mobile}">${student.mobile}</a></p>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="badge bg-danger">${student.dueAmount || 0} টাকা বকেয়া</span>
                            <button class="btn btn-sm btn-primary" onclick="payFeeForStudent('${currentClass}', '${student.name}', '${student.fatherName}', '${student.mobile}')">বেতন দিন</button>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }
        
        function fetchTodayPaidStudents(className) {
            if (navigator.onLine) {
                const today = new Date().toISOString().split('T')[0];
                fetch(API_URL + '?action=getTodayPaidStudents&class=' + className + '&date=' + today)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            displayTodayPaidStudents(data.data);
                        } else {
                            alert('ত্রুটি: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('ডাটা লোড করতে ব্যর্থ হয়েছে।');
                    });
            } else {
                alert('আপনি অফলাইনে আছেন। শুধুমাত্র পূর্বে দেখা ডাটা দেখানো যাবে।');
            }
        }
        
        function displayTodayPaidStudents(students) {
            const container = document.getElementById('today-paid-container');
            container.innerHTML = '';
            
            if (students.length === 0) {
                container.innerHTML = '<div class="alert alert-info">আজকে কেউ বেতন প্রদান করেনি</div>';
                return;
            }
            
            students.forEach(student => {
                const card = document.createElement('div');
                card.className = 'card mb-3';
                card.innerHTML = `
                    <div class="card-body">
                        <h5 class="card-title">${student.studentName}</h5>
                        <p class="card-text">পিতার নাম: ${student.fatherName}</p>
                        <p class="card-text">মোবাইল: <a href="tel:${student.mobile}">${student.mobile}</a></p>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="badge bg-success">${student.paidAmount} টাকা প্রদান করেছেন</span>
                            <small class="text-muted">${new Date(student.paymentDate).toLocaleString()}</small>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }
    </script>
</body>
</html>