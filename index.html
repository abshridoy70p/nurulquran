<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Madrasa Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: var(--dark-color);
        }
        
        .navbar {
            background-color: var(--primary-color);
        }
        
        .navbar-brand {
            font-weight: 700;
            color: white;
        }
        
        .btn-primary {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }
        
        .btn-danger {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
        }
        
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            border: none;
        }
        
        .card-header {
            background-color: var(--primary-color);
            color: white;
            border-radius: 10px 10px 0 0 !important;
        }
        
        .list-group-item {
            transition: all 0.3s;
        }
        
        .list-group-item:hover {
            background-color: var(--light-color);
            transform: translateX(5px);
        }
        
        .form-control:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 0.25rem rgba(52, 152, 219, 0.25);
        }
        
        .page {
            display: none;
        }
        
        .page.active {
            display: block;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .badge-paid {
            background-color: #2ecc71;
        }
        
        .badge-unpaid {
            background-color: #e74c3c;
        }
        
        .search-container {
            position: relative;
        }
        
        .search-results {
            position: absolute;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            background: white;
            border: 1px solid #ddd;
            border-radius: 0 0 5px 5px;
            display: none;
        }
        
        .search-result-item {
            padding: 8px 15px;
            cursor: pointer;
        }
        
        .search-result-item:hover {
            background-color: #f5f5f5;
        }
        
        .offline-notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1050;
            display: none;
        }
        
        .student-item {
            position: relative;
        }
        
        .student-actions {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
        }
        
        @media (max-width: 768px) {
            .student-actions {
                position: static;
                transform: none;
                margin-top: 10px;
                text-align: right;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark mb-4">
        <div class="container">
            <a class="navbar-brand" href="#" onclick="showPage('home-page')">Madrasa Management</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="#" onclick="showPage('home-page')">Home</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Offline Notification -->
    <div class="offline-notification alert alert-warning alert-dismissible fade show" role="alert">
        You are currently offline. Data will be saved locally and synced when you're back online.
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    <!-- Main Container -->
    <div class="container mb-5">
        <!-- Home Page -->
        <div id="home-page" class="page active">
            <div class="row mb-4">
                <div class="col-12">
                    <h2 class="text-center mb-4">Madrasa Dashboard</h2>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-4 mb-3">
                    <button class="btn btn-primary w-100 py-3" onclick="showPage('class-page'); setCurrentClass('shishu')">
                        <i class="fas fa-child me-2"></i> শিশু জামাত
                    </button>
                </div>
                <div class="col-md-4 mb-3">
                    <button class="btn btn-primary w-100 py-3" onclick="showPage('class-page'); setCurrentClass('first')">
                        <i class="fas fa-book me-2"></i> প্রথম জামাত
                    </button>
                </div>
                <div class="col-md-4 mb-3">
                    <button class="btn btn-primary w-100 py-3" onclick="showPage('class-page'); setCurrentClass('second')">
                        <i class="fas fa-book-open me-2"></i> দ্বিতীয় জামাত
                    </button>
                </div>
                <div class="col-md-4 mb-3">
                    <button class="btn btn-primary w-100 py-3" onclick="showPage('class-page'); setCurrentClass('third')">
                        <i class="fas fa-graduation-cap me-2"></i> তৃতীয় জামাত
                    </button>
                </div>
                <div class="col-md-4 mb-3">
                    <button class="btn btn-primary w-100 py-3" onclick="showPage('class-page'); setCurrentClass('hifz')">
                        <i class="fas fa-quran me-2"></i> হিফজ বিভাগ
                    </button>
                </div>
                <div class="col-md-4 mb-3">
                    <button class="btn btn-success w-100 py-3" onclick="showPage('add-student-page')">
                        <i class="fas fa-user-plus me-2"></i> Add Student
                    </button>
                </div>
                <div class="col-md-6 mb-3">
                    <button class="btn btn-info w-100 py-3" onclick="showPage('fee-management-page')">
                        <i class="fas fa-money-bill-wave me-2"></i> বেতন দিন
                    </button>
                </div>
                <div class="col-md-6 mb-3">
                    <button class="btn btn-warning w-100 py-3" onclick="showPage('unpaid-students-page')">
                        <i class="fas fa-exclamation-circle me-2"></i> Unpaid Students
                    </button>
                </div>
                <div class="col-12 mb-3">
                    <button class="btn btn-secondary w-100 py-3" onclick="showPage('today-fee-page')">
                        <i class="fas fa-list-check me-2"></i> আজকে যারা বেতন দিয়েছেন
                    </button>
                </div>
            </div>
        </div>

        <!-- Class Students Page -->
        <div id="class-page" class="page">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 id="class-title">Class Students</h2>
                <button class="btn btn-outline-primary" onclick="showPage('home-page')">
                    <i class="fas fa-arrow-left me-1"></i> Back
                </button>
            </div>
            
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>Student List</span>
                    <div>
                        <input type="text" id="class-search" class="form-control form-control-sm" placeholder="Search students..." oninput="searchStudents()">
                    </div>
                </div>
                <div class="card-body p-0">
                    <ul id="class-students-list" class="list-group list-group-flush">
                        <!-- Students will be loaded here -->
                    </ul>
                </div>
            </div>
        </div>

        <!-- Add Student Page -->
        <div id="add-student-page" class="page">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>Add New Student</h2>
                <button class="btn btn-outline-primary" onclick="showPage('home-page')">
                    <i class="fas fa-arrow-left me-1"></i> Back
                </button>
            </div>
            
            <div class="card">
                <div class="card-header">
                    Student Information
                </div>
                <div class="card-body">
                    <form id="add-student-form">
                        <div class="mb-3">
                            <label for="student-class" class="form-label">ক্লাস নির্ণয় করুন</label>
                            <select class="form-select" id="student-class" required>
                                <option value="" selected disabled>Select Class</option>
                                <option value="shishu">শিশু জামাত</option>
                                <option value="first">প্রথম জামাত</option>
                                <option value="second">দ্বিতীয় জামাত</option>
                                <option value="third">তৃতীয় জামাত</option>
                                <option value="hifz">হিফজ বিভাগ</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="student-name" class="form-label">নাম</label>
                            <input type="text" class="form-control" id="student-name" required>
                        </div>
                        <div class="mb-3">
                            <label for="father-name" class="form-label">পিতার নাম</label>
                            <input type="text" class="form-control" id="father-name" required>
                        </div>
                        <div class="mb-3">
                            <label for="mother-name" class="form-label">মাতার নাম (Optional)</label>
                            <input type="text" class="form-control" id="mother-name">
                        </div>
                        <div class="mb-3">
                            <label for="mobile-number" class="form-label">মোবাইল</label>
                            <div class="input-group">
                                <input type="tel" class="form-control" id="mobile-number" required>
                                <button class="btn btn-outline-secondary" type="button" onclick="callStudent()">
                                    <i class="fas fa-phone"></i>
                                </button>
                            </div>
                        </div>
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-1"></i> Submit
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Fee Management Page -->
        <div id="fee-management-page" class="page">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>Fee Management</h2>
                <button class="btn btn-outline-primary" onclick="showPage('home-page')">
                    <i class="fas fa-arrow-left me-1"></i> Back
                </button>
            </div>
            
            <div class="card">
                <div class="card-header">
                    Payment Information
                </div>
                <div class="card-body">
                    <form id="fee-form">
                        <div class="mb-3">
                            <label for="fee-class" class="form-label">ক্লাস নির্ণয় করুন</label>
                            <select class="form-select" id="fee-class" required onchange="loadStudentsForFee()">
                                <option value="" selected disabled>Select Class</option>
                                <option value="shishu">শিশু জামাত</option>
                                <option value="first">প্রথম জামাত</option>
                                <option value="second">দ্বিতীয় জামাত</option>
                                <option value="third">তৃতীয় জামাত</option>
                                <option value="hifz">হিফজ বিভাগ</option>
                            </select>
                        </div>
                        <div class="mb-3 search-container">
                            <label for="student-search" class="form-label">নাম</label>
                            <input type="text" class="form-control" id="student-search" placeholder="Search student..." required oninput="searchStudentForFee()">
                            <div id="search-results" class="search-results"></div>
                        </div>
                        <div class="mb-3">
                            <label for="total-fee" class="form-label">মোট বেতন</label>
                            <input type="number" class="form-control" id="total-fee" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="paid-amount" class="form-label">বর্তমান টাকা</label>
                            <input type="number" class="form-control" id="paid-amount" required oninput="calculateDue()">
                        </div>
                        <div class="mb-3">
                            <label for="due-amount" class="form-label">বকেয়া টাকা</label>
                            <input type="number" class="form-control" id="due-amount" readonly>
                        </div>
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-money-bill-wave me-1"></i> Submit Payment
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Unpaid Students Page -->
        <div id="unpaid-students-page" class="page">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>Unpaid Students</h2>
                <button class="btn btn-outline-primary" onclick="showPage('home-page')">
                    <i class="fas fa-arrow-left me-1"></i> Back
                </button>
            </div>
            
            <div class="row mb-3">
                <div class="col-12">
                    <div class="btn-group w-100" role="group">
                        <button type="button" class="btn btn-outline-primary" onclick="showUnpaidStudents('shishu')">শিশু</button>
                        <button type="button" class="btn btn-outline-primary" onclick="showUnpaidStudents('first')">প্রথম</button>
                        <button type="button" class="btn btn-outline-primary" onclick="showUnpaidStudents('second')">দ্বিতীয়</button>
                        <button type="button" class="btn btn-outline-primary" onclick="showUnpaidStudents('third')">তৃতীয়</button>
                        <button type="button" class="btn btn-outline-primary" onclick="showUnpaidStudents('hifz')">হিফজ</button>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <span id="unpaid-class-title">Unpaid Students</span>
                </div>
                <div class="card-body p-0">
                    <ul id="unpaid-students-list" class="list-group list-group-flush">
                        <!-- Unpaid students will be loaded here -->
                    </ul>
                </div>
            </div>
        </div>

        <!-- Today's Fee Records Page -->
        <div id="today-fee-page" class="page">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>Today's Fee Payments</h2>
                <button class="btn btn-outline-primary" onclick="showPage('home-page')">
                    <i class="fas fa-arrow-left me-1"></i> Back
                </button>
            </div>
            
            <div class="row mb-3">
                <div class="col-12">
                    <div class="btn-group w-100" role="group">
                        <button type="button" class="btn btn-outline-primary" onclick="showTodayPayments('shishu')">শিশু</button>
                        <button type="button" class="btn btn-outline-primary" onclick="showTodayPayments('first')">প্রথম</button>
                        <button type="button" class="btn btn-outline-primary" onclick="showTodayPayments('second')">দ্বিতীয়</button>
                        <button type="button" class="btn btn-outline-primary" onclick="showTodayPayments('third')">তৃতীয়</button>
                        <button type="button" class="btn btn-outline-primary" onclick="showTodayPayments('hifz')">হিফজ</button>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <span id="today-class-title">Today's Payments</span>
                </div>
                <div class="card-body p-0">
                    <ul id="today-payments-list" class="list-group list-group-flush">
                        <!-- Today's payments will be loaded here -->
                    </ul>
                </div>
            </div>
        </div>

        <!-- Edit Student Modal -->
        <div class="modal fade" id="editStudentModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Edit Student</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="edit-student-form">
                            <input type="hidden" id="edit-student-id">
                            <div class="mb-3">
                                <label for="edit-student-class" class="form-label">Class</label>
                                <select class="form-select" id="edit-student-class" required>
                                    <option value="shishu">শিশু জামাত</option>
                                    <option value="first">প্রথম জামাত</option>
                                    <option value="second">দ্বিতীয় জামাত</option>
                                    <option value="third">তৃতীয় জামাত</option>
                                    <option value="hifz">হিফজ বিভাগ</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="edit-student-name" class="form-label">নাম</label>
                                <input type="text" class="form-control" id="edit-student-name" required>
                            </div>
                            <div class="mb-3">
                                <label for="edit-father-name" class="form-label">পিতার নাম</label>
                                <input type="text" class="form-control" id="edit-father-name" required>
                            </div>
                            <div class="mb-3">
                                <label for="edit-mother-name" class="form-label">মাতার নাম (Optional)</label>
                                <input type="text" class="form-control" id="edit-mother-name">
                            </div>
                            <div class="mb-3">
                                <label for="edit-mobile-number" class="form-label">মোবাইল</label>
                                <input type="tel" class="form-control" id="edit-mobile-number" required>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" onclick="updateStudent()">Save Changes</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let currentClass = '';
        let currentStudentId = '';
        let students = [];
        let feeRecords = [];
        let offlineData = {
            students: [],
            fees: []
        };
        
        // Check if online
        let isOnline = navigator.onLine;
        updateOnlineStatus();
        
        // Event listeners for online/offline status
        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
        
        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            
            // Form submit handlers
            document.getElementById('add-student-form').addEventListener('submit', addStudent);
            document.getElementById('fee-form').addEventListener('submit', submitFee);
            
            // Load today's date for fee records
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('fee-date').value = today;
        });
        
        // Online status function
        function updateOnlineStatus() {
            isOnline = navigator.onLine;
            const notification = document.querySelector('.offline-notification');
            
            if (!isOnline) {
                notification.style.display = 'block';
            } else {
                notification.style.display = 'none';
                syncOfflineData();
            }
        }
        
        // Page navigation functions
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId).classList.add('active');
            
            // Scroll to top when changing pages
            window.scrollTo(0, 0);
            
            // Load specific data if needed
            if (pageId === 'unpaid-students-page') {
                showUnpaidStudents('shishu');
            } else if (pageId === 'today-fee-page') {
                showTodayPayments('shishu');
            }
        }
        
        function setCurrentClass(className) {
            currentClass = className;
            const classTitles = {
                'shishu': 'শিশু জামাত',
                'first': 'প্রথম জামাত',
                'second': 'দ্বিতীয় জামাত',
                'third': 'তৃতীয় জামাত',
                'hifz': 'হিফজ বিভাগ'
            };
            document.getElementById('class-title').textContent = classTitles[className] + ' Students';
            loadClassStudents(className);
        }
        
        // Data loading functions
        function loadData() {
            // Load from localStorage
            const savedStudents = localStorage.getItem('madrasaStudents');
            const savedFees = localStorage.getItem('madrasaFeeRecords');
            const savedOffline = localStorage.getItem('madrasaOfflineData');
            
            if (savedStudents) {
                students = JSON.parse(savedStudents);
            }
            
            if (savedFees) {
                feeRecords = JSON.parse(savedFees);
            }
            
            if (savedOffline) {
                offlineData = JSON.parse(savedOffline);
            }
            
            // In a real app, you would also load from Google Sheets here
        }
        
        function loadClassStudents(className) {
            const classStudents = students.filter(student => student.class === className);
            const listElement = document.getElementById('class-students-list');
            listElement.innerHTML = '';
            
            if (classStudents.length === 0) {
                listElement.innerHTML = '<li class="list-group-item text-center text-muted">No students found</li>';
                return;
            }
            
            // Sort by registration date (oldest first)
            classStudents.sort((a, b) => new Date(a.registrationDate) - new Date(b.registrationDate));
            
            classStudents.forEach(student => {
                // Calculate fee status
                const studentFees = feeRecords.filter(fee => fee.studentId === student.id);
                const totalPaid = studentFees.reduce((sum, fee) => sum + fee.amount, 0);
                const monthsPaid = studentFees.length;
                const monthsDue = calculateMonthsDue(student.registrationDate, monthsPaid);
                
                const listItem = document.createElement('li');
                listItem.className = 'list-group-item student-item';
                listItem.innerHTML = `
                    <div>
                        <h5>${student.name}</h5>
                        <p class="mb-1">পিতা: ${student.fatherName} | মোবাইল: <a href="tel:${student.mobile}">${student.mobile}</a></p>
                        <div>
                            <span class="badge rounded-pill bg-success">Paid: ${monthsPaid} months</span>
                            <span class="badge rounded-pill bg-danger">Due: ${monthsDue} months</span>
                            <span class="badge rounded-pill bg-primary">Total: ৳${totalPaid}</span>
                        </div>
                    </div>
                    <div class="student-actions">
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editStudent('${student.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger me-1" onclick="deleteStudent('${student.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-success" onclick="payFeeForStudent('${student.id}')">
                            <i class="fas fa-money-bill"></i> Fee
                        </button>
                    </div>
                `;
                listElement.appendChild(listItem);
            });
        }
        
        function calculateMonthsDue(registrationDate, monthsPaid) {
            const regDate = new Date(registrationDate);
            const now = new Date();
            const monthsRegistered = (now.getFullYear() - regDate.getFullYear()) * 12 + (now.getMonth() - regDate.getMonth());
            return Math.max(0, monthsRegistered - monthsPaid);
        }
        
        // Student CRUD functions
        function addStudent(e) {
            e.preventDefault();
            
            const studentClass = document.getElementById('student-class').value;
            const name = document.getElementById('student-name').value;
            const fatherName = document.getElementById('father-name').value;
            const motherName = document.getElementById('mother-name').value;
            const mobile = document.getElementById('mobile-number').value;
            
            const newStudent = {
                id: generateId(),
                class: studentClass,
                name: name,
                fatherName: fatherName,
                motherName: motherName,
                mobile: mobile,
                registrationDate: new Date().toISOString()
            };
            
            if (isOnline) {
                // In a real app, you would save to Google Sheets here
                students.push(newStudent);
                saveData();
            } else {
                offlineData.students.push(newStudent);
                saveOfflineData();
            }
            
            // Reset form
            e.target.reset();
            
            // Show success message
            alert('Student added successfully!');
            
            // Return to home page
            showPage('home-page');
        }
        
        function editStudent(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            document.getElementById('edit-student-id').value = student.id;
            document.getElementById('edit-student-class').value = student.class;
            document.getElementById('edit-student-name').value = student.name;
            document.getElementById('edit-father-name').value = student.fatherName;
            document.getElementById('edit-mother-name').value = student.motherName || '';
            document.getElementById('edit-mobile-number').value = student.mobile;
            
            const modal = new bootstrap.Modal(document.getElementById('editStudentModal'));
            modal.show();
        }
        
        function updateStudent() {
            const studentId = document.getElementById('edit-student-id').value;
            const studentIndex = students.findIndex(s => s.id === studentId);
            
            if (studentIndex === -1) return;
            
            students[studentIndex] = {
                ...students[studentIndex],
                class: document.getElementById('edit-student-class').value,
                name: document.getElementById('edit-student-name').value,
                fatherName: document.getElementById('edit-father-name').value,
                motherName: document.getElementById('edit-mother-name').value,
                mobile: document.getElementById('edit-mobile-number').value
            };
            
            if (isOnline) {
                saveData();
            } else {
                // Find if this student exists in offline data
                const offlineIndex = offlineData.students.findIndex(s => s.id === studentId);
                if (offlineIndex !== -1) {
                    offlineData.students[offlineIndex] = students[studentIndex];
                } else {
                    offlineData.students.push(students[studentIndex]);
                }
                saveOfflineData();
            }
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('editStudentModal'));
            modal.hide();
            
            // Reload class students if we're on that page
            if (document.getElementById('class-page').classList.contains('active')) {
                loadClassStudents(currentClass);
            }
        }
        
        function deleteStudent(studentId) {
            if (!confirm('Are you sure you want to delete this student?')) return;
            
            const studentIndex = students.findIndex(s => s.id === studentId);
            if (studentIndex === -1) return;
            
            if (isOnline) {
                // In a real app, you would delete from Google Sheets here
                students.splice(studentIndex, 1);
                saveData();
            } else {
                // Add to offline deletions
                const student = students[studentIndex];
                offlineData.students = offlineData.students.filter(s => s.id !== studentId);
                saveOfflineData();
                
                // Remove from local students array
                students.splice(studentIndex, 1);
                localStorage.setItem('madrasaStudents', JSON.stringify(students));
            }
            
            // Reload class students if we're on that page
            if (document.getElementById('class-page').classList.contains('active')) {
                loadClassStudents(currentClass);
            }
        }
        
        // Fee management functions
        function loadStudentsForFee() {
            const className = document.getElementById('fee-class').value;
            const studentSearch = document.getElementById('student-search');
            studentSearch.value = '';
            studentSearch.focus();
        }
        
        function searchStudentForFee() {
            const searchTerm = document.getElementById('student-search').value.toLowerCase();
            const className = document.getElementById('fee-class').value;
            
            if (!className) {
                alert('Please select a class first');
                return;
            }
            
            if (searchTerm.length < 2) {
                document.getElementById('search-results').style.display = 'none';
                return;
            }
            
            const classStudents = students.filter(student => 
                student.class === className && 
                (student.name.toLowerCase().includes(searchTerm) || 
                 student.fatherName.toLowerCase().includes(searchTerm))
            );
            
            const resultsContainer = document.getElementById('search-results');
            resultsContainer.innerHTML = '';
            
            if (classStudents.length === 0) {
                resultsContainer.innerHTML = '<div class="search-result-item">No students found</div>';
            } else {
                classStudents.forEach(student => {
                    const resultItem = document.createElement('div');
                    resultItem.className = 'search-result-item';
                    resultItem.textContent = `${student.name} (পিতা: ${student.fatherName})`;
                    resultItem.onclick = () => selectStudentForFee(student);
                    resultsContainer.appendChild(resultItem);
                });
            }
            
            resultsContainer.style.display = 'block';
        }
        
        function selectStudentForFee(student) {
            document.getElementById('student-search').value = `${student.name} (পিতা: ${student.fatherName})`;
            document.getElementById('search-results').style.display = 'none';
            
            // Calculate fee status
            const studentFees = feeRecords.filter(fee => fee.studentId === student.id);
            const monthsPaid = studentFees.length;
            const monthsDue = calculateMonthsDue(student.registrationDate, monthsPaid);
            
            // Set values
            currentStudentId = student.id;
            document.getElementById('total-fee').value = monthsDue * 500; // Assuming 500 is monthly fee
            document.getElementById('paid-amount').value = '';
            document.getElementById('due-amount').value = monthsDue * 500;
        }
        
        function calculateDue() {
            const total = parseFloat(document.getElementById('total-fee').value) || 0;
            const paid = parseFloat(document.getElementById('paid-amount').value) || 0;
            document.getElementById('due-amount').value = Math.max(0, total - paid);
        }
        
        function submitFee(e) {
            e.preventDefault();
            
            if (!currentStudentId) {
                alert('Please select a student first');
                return;
            }
            
            const className = document.getElementById('fee-class').value;
            const amount = parseFloat(document.getElementById('paid-amount').value);
            
            if (!amount || amount <= 0) {
                alert('Please enter a valid amount');
                return;
            }
            
            const newFee = {
                id: generateId(),
                studentId: currentStudentId,
                class: className,
                amount: amount,
                paymentDate: new Date().toISOString()
            };
            
            if (isOnline) {
                // In a real app, you would save to Google Sheets here
                feeRecords.push(newFee);
                saveData();
            } else {
                offlineData.fees.push(newFee);
                saveOfflineData();
            }
            
            // Reset form
            e.target.reset();
            currentStudentId = '';
            
            // Show success message
            alert('Fee payment recorded successfully!');
            
            // Return to home page
            showPage('home-page');
        }
        
        function payFeeForStudent(studentId) {
            showPage('fee-management-page');
            currentStudentId = studentId;
            
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            // Set class
            document.getElementById('fee-class').value = student.class;
            
            // Set student name
            document.getElementById('student-search').value = `${student.name} (পিতা: ${student.fatherName})`;
            
            // Calculate fee status
            const studentFees = feeRecords.filter(fee => fee.studentId === student.id);
            const monthsPaid = studentFees.length;
            const monthsDue = calculateMonthsDue(student.registrationDate, monthsPaid);
            
            // Set values
            document.getElementById('total-fee').value = monthsDue * 500; // Assuming 500 is monthly fee
            document.getElementById('paid-amount').value = '';
            document.getElementById('due-amount').value = monthsDue * 500;
            
            // Focus on amount field
            document.getElementById('paid-amount').focus();
        }
        
        // Unpaid students functions
        function showUnpaidStudents(className) {
            const classStudents = students.filter(student => student.class === className);
            const unpaidStudents = [];
            
            const classTitles = {
                'shishu': 'শিশু জামাত',
                'first': 'প্রথম জামাত',
                'second': 'দ্বিতীয় জামাত',
                'third': 'তৃতীয় জামাত',
                'hifz': 'হিফজ বিভাগ'
            };
            
            document.getElementById('unpaid-class-title').textContent = `Unpaid Students - ${classTitles[className]}`;
            
            classStudents.forEach(student => {
                const studentFees = feeRecords.filter(fee => fee.studentId === student.id);
                const monthsPaid = studentFees.length;
                const monthsDue = calculateMonthsDue(student.registrationDate, monthsPaid);
                
                if (monthsDue > 0) {
                    unpaidStudents.push({
                        ...student,
                        monthsDue: monthsDue,
                        amountDue: monthsDue * 500 // Assuming 500 is monthly fee
                    });
                }
            });
            
            const listElement = document.getElementById('unpaid-students-list');
            listElement.innerHTML = '';
            
            if (unpaidStudents.length === 0) {
                listElement.innerHTML = '<li class="list-group-item text-center text-muted">No unpaid students found</li>';
                return;
            }
            
            unpaidStudents.forEach(student => {
                const listItem = document.createElement('li');
                listItem.className = 'list-group-item student-item';
                listItem.innerHTML = `
                    <div>
                        <h5>${student.name}</h5>
                        <p class="mb-1">পিতা: ${student.fatherName} | মোবাইল: <a href="tel:${student.mobile}">${student.mobile}</a></p>
                        <div>
                            <span class="badge rounded-pill bg-danger">Due: ${student.monthsDue} months (৳${student.amountDue})</span>
                        </div>
                    </div>
                    <div class="student-actions">
                        <button class="btn btn-sm btn-outline-success" onclick="payFeeForStudent('${student.id}')">
                            <i class="fas fa-money-bill"></i> Pay Now
                        </button>
                    </div>
                `;
                listElement.appendChild(listItem);
            });
        }
        
        // Today's payments functions
        function showTodayPayments(className) {
            const today = new Date().toISOString().split('T')[0];
            const classPayments = feeRecords.filter(fee => 
                fee.class === className && 
                fee.paymentDate.startsWith(today)
            );
            
            const classTitles = {
                'shishu': 'শিশু জামাত',
                'first': 'প্রথম জামাত',
                'second': 'দ্বিতীয় জামাত',
                'third': 'তৃতীয় জামাত',
                'hifz': 'হিফজ বিভাগ'
            };
            
            document.getElementById('today-class-title').textContent = `Today's Payments - ${classTitles[className]}`;
            
            const listElement = document.getElementById('today-payments-list');
            listElement.innerHTML = '';
            
            if (classPayments.length === 0) {
                listElement.innerHTML = '<li class="list-group-item text-center text-muted">No payments found for today</li>';
                return;
            }
            
            // Calculate total
            const totalAmount = classPayments.reduce((sum, payment) => sum + payment.amount, 0);
            
            // Add total item
            const totalItem = document.createElement('li');
            totalItem.className = 'list-group-item bg-light';
            totalItem.innerHTML = `<strong>Total: ৳${totalAmount} (${classPayments.length} payments)</strong>`;
            listElement.appendChild(totalItem);
            
            // Add payment items
            classPayments.forEach(payment => {
                const student = students.find(s => s.id === payment.studentId);
                if (!student) return;
                
                const listItem = document.createElement('li');
                listItem.className = 'list-group-item';
                listItem.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6>${student.name}</h6>
                            <p class="mb-0 small">পিতা: ${student.fatherName}</p>
                        </div>
                        <span class="badge bg-success rounded-pill">৳${payment.amount}</span>
                    </div>
                `;
                listElement.appendChild(listItem);
            });
        }
        
        // Search functions
        function searchStudents() {
            const searchTerm = document.getElementById('class-search').value.toLowerCase();
            const classStudents = students.filter(student => 
                student.class === currentClass && 
                (student.name.toLowerCase().includes(searchTerm) || 
                 student.fatherName.toLowerCase().includes(searchTerm) ||
                 student.mobile.includes(searchTerm))
            );
            
            const listElement = document.getElementById('class-students-list');
            listElement.innerHTML = '';
            
            if (classStudents.length === 0) {
                listElement.innerHTML = '<li class="list-group-item text-center text-muted">No students found</li>';
                return;
            }
            
            classStudents.forEach(student => {
                // Calculate fee status
                const studentFees = feeRecords.filter(fee => fee.studentId === student.id);
                const monthsPaid = studentFees.length;
                const monthsDue = calculateMonthsDue(student.registrationDate, monthsPaid);
                
                const listItem = document.createElement('li');
                listItem.className = 'list-group-item student-item';
                listItem.innerHTML = `
                    <div>
                        <h5>${student.name}</h5>
                        <p class="mb-1">পিতা: ${student.fatherName} | মোবাইল: <a href="tel:${student.mobile}">${student.mobile}</a></p>
                        <div>
                            <span class="badge rounded-pill bg-success">Paid: ${monthsPaid} months</span>
                            <span class="badge rounded-pill bg-danger">Due: ${monthsDue} months</span>
                        </div>
                    </div>
                    <div class="student-actions">
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editStudent('${student.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger me-1" onclick="deleteStudent('${student.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-success" onclick="payFeeForStudent('${student.id}')">
                            <i class="fas fa-money-bill"></i> Fee
                        </button>
                    </div>
                `;
                listElement.appendChild(listItem);
            });
        }
        
        // Utility functions
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }
        
        function callStudent() {
            const mobile = document.getElementById('mobile-number').value;
            if (mobile) {
                window.open(`tel:${mobile}`);
            }
        }
        
        function saveData() {
            localStorage.setItem('madrasaStudents', JSON.stringify(students));
            localStorage.setItem('madrasaFeeRecords', JSON.stringify(feeRecords));
            
            // In a real app, you would sync with Google Sheets here
        }
        
        function saveOfflineData() {
            localStorage.setItem('madrasaOfflineData', JSON.stringify(offlineData));
        }
        
        function syncOfflineData() {
            if (offlineData.students.length > 0 || offlineData.fees.length > 0) {
                // In a real app, you would sync with Google Sheets here
                // For now, we'll just move the data to the main arrays
                students = [...students, ...offlineData.students];
                feeRecords = [...feeRecords, ...offlineData.fees];
                
                saveData();
                
                // Clear offline data
                offlineData = {
                    students: [],
                    fees: []
                };
                saveOfflineData();
                
                alert('Offline data has been synced!');
            }
        }
    </script>
</body>
</html>